name: RikkaHub Release Build
on:
  workflow_dispatch:

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è¿˜åŸ Google Services
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: è¿˜åŸæ—§ç‰ˆå›¾æ ‡ï¼ˆè¦†ç›–ä¸Šæ¸¸æ›´æ–°ï¼‰
        run: |
          # å¤åˆ¶æ—§ç‰ˆå›¾æ ‡è¦†ç›–ä¸Šæ¸¸æ–°ç‰ˆæœ¬
          cp ci-assets/ic_launcher_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp ci-assets/ic_launcher_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

          cp ci-assets/ic_launcher_background_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_background.png

          cp ci-assets/ic_launcher_foreground_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png

          cp ci-assets/ic_launcher_monochrome_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_monochrome.png

          cp ci-assets/rikkahub.svg app/src/main/assets/icons/rikkahub.svg

          echo "âœ… å›¾æ ‡å·²è¿˜åŸä¸ºæ—§ç‰ˆæœ¬"

      - name: æ›¿æ¢æ›´æ–°æ£€æŸ¥åœ°å€
        run: |
          # æ›¿æ¢ UpdateChecker.kt ä¸­çš„æ›´æ–°åœ°å€ä¸ºè‡ªå®šä¹‰åœ°å€
          sed -i 's|https://updates.rikka-ai.com/|https://my-rikkahub-update.edgeone.run/update.json|g' app/src/main/java/me/rerere/rikkahub/utils/UpdateChecker.kt
          echo "âœ… æ›´æ–°æ£€æŸ¥åœ°å€å·²æ›¿æ¢ä¸ºï¼šhttps://my-rikkahub-update.edgeone.run/update.json"

        
      - name: ä¿®æ”¹ç‰ˆæœ¬å·
        id: version_update
        run: |
          BUILD_DATE=$(TZ='Asia/Shanghai' date '+%Y%m%d')
          VERSION_NAME=$(grep 'versionName =' app/build.gradle.kts | sed 's/.*versionName = "\([^"]*\)".*/\1/')
          NEW_VERSION_NAME="${VERSION_NAME}-${BUILD_DATE}"
          sed -i "s/versionName = \".*\"/versionName = \"${NEW_VERSION_NAME}\"/" app/build.gradle.kts
          echo "ç‰ˆæœ¬å·å·²æ›´æ–°ï¼š${VERSION_NAME} -> ${NEW_VERSION_NAME}"
          echo "original_version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "new_version=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT      
          echo "âœ… å·²ä¿®æ”¹ç‰ˆæœ¬å·"
            
      - name: è§£ç å¯†é’¥åˆ°æ¨¡å—ç›®å½•
        run: |
          # ç›´æ¥åœ¨é¡¹ç›®æ ¹ç›®å½•ç”¨ echo é‡å®šå‘åˆ° app/ ä¸‹
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/release-key.p12
          # éªŒè¯æ–‡ä»¶
          ls -lh app/release-key.p12
          stat app/release-key.p12

      - name: ç”Ÿæˆ local.properties
        run: |
          # storeFile åªå†™æ–‡ä»¶åï¼ï¼ï¼ï¼å› ä¸ºæ¨¡å—çº§çš„ file() ç›¸å¯¹äº app/
          cat > local.properties << EOF
          # CI Auto Generated for RikkaHub
          storeFile=release-key.p12
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          storeType=PKCS12
          EOF
          
      - name: é…ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: é…ç½® Gradle
        uses: gradle/actions/setup-gradle@v4
         
      - name: èµ‹äºˆæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: æ„å»º APK + AAB
        run: ./gradlew assembleRelease bundleRelease --warning-mode=summary --no-daemon --parallel

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: rikkahub-final-builds
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7

      - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          ORIGINAL_VERSION=${{ steps.version_update.outputs.original_version }}
          NEW_VERSION_NAME=${{ steps.version_update.outputs.new_version }}

          # è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©çš„ commit
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r '
              [.[] | select(.commit.author.date >= "'$TODAY_START'")] |
              map("- \(.commit.message | split("\n")[0]) (\(.commit.author.name))") |
              join("\n")
            ')

          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            COMMIT_LIST="* ä»Šå¤©æš‚æ—  commit *"
          fi

          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_VERSION_NAME" >> $GITHUB_OUTPUT

          # ç”Ÿæˆ Release æè¿°
          cat > release_notes.md << EOF
          ğŸ“± RikkaHub ä¸Šæ¸¸é¡¹ç›® https://github.com/rikkahub/rikkahub

          ğŸ”€ ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥ Commit
          $COMMIT_LIST

          âš™ï¸ CI è‡ªå®šä¹‰ä¿®æ”¹
          - ğŸ”„ ä¿®æ”¹äº†ç‰ˆæœ¬å·ï¼š\`${ORIGINAL_VERSION}\` â†’ \`${NEW_VERSION_NAME}\`
          - ğŸ¨ ä¿®æ”¹æˆäº†æ—§ç‰ˆçš„å›¾æ ‡æ–‡ä»¶
          - ğŸŒ å·²ä¿®æ”¹æ›´æ–°åœ°å€ä¸ºè‡ªå®šä¹‰åœ°å€ï¼ˆä¸‹è½½åœ°å€æŒ‡å‘æœ¬é¡¹ç›®çš„æ¯æ—¥æ„å»ºï¼‰
            - æ›´æ–°æ£€æŸ¥åœ°å€ï¼šhttps://my-rikkahub-update.edgeone.run/update.json
            - APK ä¸‹è½½åœ°å€ï¼šhttps://gh.llkk.cc/https://github.com/ruitong719/rikkahub-ci/releases/download/latest/app-release.apk

          â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
          - ğŸ·ï¸ ç‰ˆæœ¬å·ï¼š**${NEW_VERSION_NAME}**
          - â° æ„å»ºæ—¶é—´ï¼š$BUILD_TIME
          - âœ… æäº¤ SHAï¼š$SHORT_SHA
          - ğŸ”¨ åˆ†æ”¯ï¼š$BRANCH_NAME

          EOF

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ğŸš€ Latest Release (${{ steps.version_info.outputs.short_sha }})
          body_path: release_notes.md
          prerelease: false
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆæ›´æ–° JSON æ–‡ä»¶
        id: update_json
        run: |
          # è·å–æ„å»ºä¿¡æ¯
          NEW_VERSION_NAME=${{ steps.version_update.outputs.new_version }}
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          
          # è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©çš„ commit ä½œä¸º changelog
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r '
              [.[] | select(.commit.author.date >= "'$TODAY_START'")] |
              map("- \(.commit.message | split("\n")[0])") |
              join("\n")
            ')
          
          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            COMMIT_LIST="ä»Šå¤©æš‚æ—  commit"
          fi

          # æŸ¥æ‰¾ APK æ–‡ä»¶å¹¶è®¡ç®—å¤§å°
          APK_FILE=$(find app/build/outputs/apk/release -name "app-release.apk" -type f | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi

          # è®¡ç®—æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
          APK_SIZE_BYTES=$(stat -c%s "$APK_FILE")

          # è½¬æ¢ä¸ºäººç±»å¯è¯»æ ¼å¼ï¼ˆMBï¼‰
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE_BYTES / 1024 / 1024" | bc)

          # å›ºå®šä¸‹è½½åœ°å€
          APK_URL="https://gh.llkk.cc/https://github.com/ruitong719/rikkahub-ci/releases/download/latest/app-release.apk"

          # ä½¿ç”¨ jq æ­£ç¡®ç”Ÿæˆ JSONï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          jq -n \
            --arg version "${NEW_VERSION_NAME}" \
            --arg publishedAt "${BUILD_TIME}" \
            --arg changelog "${COMMIT_LIST}" \
            --arg name "app-release.apk" \
            --arg url "${APK_URL}" \
            --arg size "${APK_SIZE_MB} MB" \
            '{
              version: $version,
              publishedAt: $publishedAt,
              changelog: $changelog,
              downloads: [
                {
                  name: $name,
                  url: $url,
                  size: $size
                }
              ]
            }' > update.json

      - name: éƒ¨ç½²åˆ° EdgeOne Pages
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p edgeone-deploy
          
          # å¤åˆ¶ update.json åˆ°éƒ¨ç½²ç›®å½•
          cp update.json edgeone-deploy/update.json
          
          # å®‰è£… edgeone CLI
          npm install -g edgeone
          
          # éƒ¨ç½²åˆ° EdgeOne Pages
          edgeone pages deploy edgeone-deploy -n my-rikkahub-update -t ${{ secrets.EDGEONE_API_TOKEN }} -e production
          
          echo "âœ… æ›´æ–°æ—¥å¿—æ–‡ä»¶å·²éƒ¨ç½²åˆ° EdgeOne Pages"
