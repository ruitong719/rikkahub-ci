name: Android Release Build
on:
  workflow_dispatch:      # ğŸ”˜ æ‰‹åŠ¨è§¦å‘å‘å¸ƒ
  push:
    tags:
      - 'v*'            # ğŸ·ï¸ æ¨é€å¸¦ç‰ˆæœ¬å·çš„ tag æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚ v1.9.0ï¼‰
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # ğŸ” å…è®¸åˆ›å»º/æ›´æ–° Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup google-services.json
        run: |
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json
      # ğŸ”‘ åŠ¨æ€ç”Ÿæˆ local.propertiesï¼ˆä¸æ”¹åŠ¨é¡¹ç›®æ–‡ä»¶ï¼ï¼‰
      - name: Generate local.properties for signing
        run: |
          cat > app/local.properties <<EOF
          storeFile=keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
          cat app/local.properties
      # ğŸ”‘ è§£ç å¹¶æ”¾ç½® keystore æ–‡ä»¶
      - name: Setup Keystore
        run: |
          echo '${{ secrets.KEYSTORE_FILE }}' | base64 -d > app/keystore.jks
          ls -lh app/keystore.jks
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Cache Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/jdks
          key: ${{ runner.os }}-gradle-deps-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-deps-
      - name: Cache Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/build-cache
            .gradle/build-cache
          key: ${{ runner.os }}-build-cache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-cache-
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ğŸ›¡ï¸ ã€æ–°å¢ã€‘ä¸´æ—¶æ·»åŠ  R8 è§„åˆ™ï¼Œä¿®å¤ Ktor ç¼ºå¤±ç±»é—®é¢˜
      - name: Fix R8 Missing Classes for Ktor
        run: |
          # ç¡®ä¿ proguard-rules.pro æ–‡ä»¶å­˜åœ¨
          if [ ! -f app/proguard-rules.pro ]; then
            touch app/proguard-rules.pro
          fi
          # è¿½åŠ è§„åˆ™ï¼šå¿½ç•¥ç¼ºå¤±çš„ JVM ç®¡ç†ç±»ï¼Œå¤„ç† Ktor è°ƒè¯•ä»£ç 
          cat >> app/proguard-rules.pro << 'EOF'
          # Fix for Ktor missing java.lang.management classes on Android
          -dontwarn java.lang.management.ManagementFactory
          -dontwarn java.lang.management.RuntimeMXBean
          -dontwarn io.ktor.util.debug.**
          -keep class io.ktor.util.debug.IntellijIdeaDebugDetector { *; }
          EOF

      # ğŸ”¨ æ„å»º Release ç‰ˆæœ¬ï¼ˆAPK + AABï¼‰
      - name: Build Release APK & AAB
        run: |
          ./gradlew assembleRelease bundleRelease \
            --no-daemon \
            --build-cache \
            --parallel \
            --max-workers=2
      # ğŸ” éªŒè¯æ„å»ºäº§ç‰©
      - name: Find APK/AAB files
        run: |
          echo "=== APK files ==="
          find app/build/outputs/apk/release -name "*.apk" -type f 2>/dev/null || echo "No APK found"
          echo ""
          echo "=== AAB files ==="
          find app/build/outputs/bundle/release -name "*.aab" -type f 2>/dev/null || echo "No AAB found"
      # ğŸ“¦ ä¸Šä¼ åˆ° Artifactsï¼ˆä¸´æ—¶ï¼Œ7å¤©ï¼‰
      - name: Upload APK/AAB to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release-builds
          path: |
            app/build/outputs/apk/release/*-release.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7
      # ğŸš€ ä¸Šä¼ åˆ° GitHub Releaseï¼ˆæ°¸ä¹…ï¼‰
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}  # ä½¿ç”¨è§¦å‘çš„ tag åç§°
          name: ğŸ‰ RikkaHub v${{ github.ref_name }}
          body: |
            ## ğŸ“± RikkaHub Release ç‰ˆæœ¬
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **app-universal-release.apk**: é€šç”¨ç‰ˆæœ¬ï¼Œå…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼ˆæ¨èï¼‰
            - **app-arm64-v8a-release.apk**: ARM64 ä¸“ç”¨ï¼ˆä½“ç§¯å°ï¼Œæ€§èƒ½ä¼˜ï¼‰
            - **app-x86_64-release.apk**: x86_64 ä¸“ç”¨
            - **app-release.aab**: Google Play ä¸Šä¼ æ ¼å¼ï¼ˆæ¨èä¸Šæ¶ä½¿ç”¨ï¼‰
            
            ### â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
            - ç‰ˆæœ¬å·: ${{ github.ref_name }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp || github.event.head_commit.committer.date }}
            - æäº¤ SHA: ${{ github.sha }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            
            ### âœ¨ ç‰ˆæœ¬äº®ç‚¹
            <!-- åœ¨æ­¤å¤„å¡«å†™æœ¬æ¬¡æ›´æ–°å†…å®¹ -->
            - æ–°å¢åŠŸèƒ½...
            - ä¿®å¤é—®é¢˜...
            - ä¼˜åŒ–ä½“éªŒ...
            
            > âš ï¸ **æ³¨æ„**: 
            > - Release ç‰ˆæœ¬å·²ç­¾åå¹¶ä¼˜åŒ–ï¼Œå¯ç›´æ¥å®‰è£…ä½¿ç”¨
            > - å¦‚éœ€ä¸Šæ¶ Google Playï¼Œè¯·ä½¿ç”¨ `.aab` æ–‡ä»¶
          files: |
            app/build/outputs/apk/release/*-release.apk
            app/build/outputs/bundle/release/*.aab
          prerelease: false    # æ­£å¼å‘å¸ƒ
          draft: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
