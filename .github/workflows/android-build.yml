name: ðŸš€ RikkaHub æœ€ç»ˆç¨³å®šæž„å»º
on:
  workflow_dispatch:
  push:
    branches:
      - '**'

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è¿˜åŽŸ Google Services
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: 3. ðŸ” è§£ç å¯†é’¥åˆ°æ¨¡å—ç›®å½•ï¼ˆapp/ï¼‰
        run: |
          # ç›´æŽ¥åœ¨é¡¹ç›®æ ¹ç›®å½•ç”¨ echo é‡å®šå‘åˆ° app/ ä¸‹ï¼Œè·¯å¾„ç»å¯¹æ¸…æ™°
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/release-key.p12
          # åŒéªŒè¯æ–‡ä»¶åœ¨
          ls -lh app/release-key.p12
          stat app/release-key.p12

      - name: 4. ðŸ“ ç”Ÿæˆé€‚é…æ¨¡å—çº§è·¯å¾„çš„ local.properties
        run: |
          # storeFile åªå†™æ–‡ä»¶åï¼ï¼ï¼ï¼å› ä¸ºæ¨¡å—çº§çš„ file() ç›¸å¯¹äºŽ app/
          cat > local.properties << EOF
          # CI Auto Generated for RikkaHub (Kotlin DSL æ¨¡å—çº§é€‚é…)
          storeFile=release-key.p12
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          storeType=PKCS12
          EOF
          
          # æ‰“å°æœ€ç»ˆå†…å®¹ç¡®è®¤
          echo "--- âœ… æœ€ç»ˆ local.properties å†…å®¹ ---"
          cat local.properties
          echo ""
          echo "--- âœ… å½“å‰ç›®å½•ç»“æž„ ---"
          ls -la
          echo ""
          echo "--- âœ… App æ¨¡å—ç›®å½•ç»“æž„ ---"
          ls -la app/
     
      # ðŸ›¡ï¸ ã€æ–°å¢žã€‘ä¸´æ—¶æ·»åŠ  R8 è§„åˆ™ï¼Œä¿®å¤ Ktor ç¼ºå¤±ç±»é—®é¢˜
      - name: Fix R8 Missing Classes for Ktor
        run: |
          # ç¡®ä¿ proguard-rules.pro æ–‡ä»¶å­˜åœ¨
          if [ ! -f app/proguard-rules.pro ]; then
            touch app/proguard-rules.pro
          fi
          # è¿½åŠ è§„åˆ™ï¼šå¿½ç•¥ç¼ºå¤±çš„ JVM ç®¡ç†ç±»ï¼Œå¤„ç† Ktor è°ƒè¯•ä»£ç 
          cat >> app/proguard-rules.pro << 'EOF'
          # Fix for Ktor missing java.lang.management classes on Android
          -dontwarn java.lang.management.ManagementFactory
          -dontwarn java.lang.management.RuntimeMXBean
          -dontwarn io.ktor.util.debug.**
          -keep class io.ktor.util.debug.IntellijIdeaDebugDetector { *; }
          EOF
      
      - name: 5. é…ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 6. èµ‹äºˆæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: 7. ðŸ”¨ æž„å»º APK + AABï¼ˆå¿…æˆç‰ˆï¼‰
        run: ./gradlew assembleRelease bundleRelease --no-daemon --build-cache --parallel

      - name: 8. ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: rikkahub-final-builds
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7

      - name: 9. ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          
          # èŽ·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©åˆå¹¶çš„ PR
          TODAY_START=$(TZ='Asia/Shanghai' date -d 'today' '+%Y-%m-%dT00:00:00+08:00')
          PR_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/pulls?state=closed&per_page=100" | \
            jq -r --arg today "$TODAY_START" '
              [.[] | select(.merged_at != null and .merged_at >= $today)] |
              sort_by(.merged_at) | reverse |
              .[:20] |
              map("- #\(.number) \(.title) (@\(.user.login))") |
              join("\n")
            ')
          
          if [ -z "$PR_LIST" ] || [ "$PR_LIST" = "null" ]; then
            PR_LIST="* ä»Šå¤©æš‚æ— åˆå¹¶çš„ PR *"
          fi
          
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆ Release æè¿°
          cat > release_notes.md << EOF
          ðŸ“± RikkaHub ä¸Šæ¸¸é¡¹ç›® https://github.com/rikkahub/rikkahub
     
          
          ðŸ”€ ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥åˆå¹¶çš„ PR
          $PR_LIST
          
          â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
          - æž„å»ºæ—¶é—´ï¼š$BUILD_TIME
          - æäº¤ SHAï¼š$SHORT_SHA
          - åˆ†æ”¯ï¼š$BRANCH_NAME
          EOF

      - name: 10. ðŸš€ å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ðŸš€ Latest Release (${{ steps.version_info.outputs.short_sha }})
          body_path: release_notes.md
          prerelease: false
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
