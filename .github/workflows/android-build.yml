name: 🔑 Keystore 验证纯测试（兼容 PKCS12 版）
on:
  workflow_dispatch:

jobs:
  verify_signing:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 1 }

      - name: 2. Setup Java
        uses: actions/setup-java@v4
        with: { java-version: '17', distribution: 'temurin' }

      - name: 3. 🔐 解码 Keystore
        id: decode_keystore
        run: |
          mkdir -p app/
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/keystore.p12
          
          if [ -f app/keystore.p12 ]; then
              SIZE_KB=$(du -k app/keystore.p12 | awk '{print $1}')
              echo "✅ 文件生成 (${SIZE_KB} KB)"
              if [ "${SIZE_KB}" -lt 1 ]; then exit 1; fi
          else
              echo "❌ 文件未生成" && exit 1
          fi

      - name: 4. 🧩 全能验证 (兼容 PKCS12/JKS)
        id: keytool_verify
        run: |
          echo "--- 步骤4.1: 列出所有信息，验证主密码 ---"
          # -v 会显示详细信息，同时也验证了 store password
          if keytool -list -v -keystore app/keystore.p12 -storepass "${{ secrets.KEYSTORE_PASSWORD }}" -noprompt > keystore_info.txt; then
              echo "✅ Keystore 主密码正确"
          else
              echo "❌ 主密码错误" && exit 1
          fi
          echo ""

          echo "--- 步骤4.2: 检查别名是否存在 ---"
          # 从刚才的输出里找别名
          if grep -q "Alias name: ${{ secrets.KEY_ALIAS }}" keystore_info.txt; then
              echo "✅ 别名 (${{ secrets.KEY_ALIAS }}) 存在"
          else
              echo "❌ 别名不存在，下面是找到的所有别名："
              grep "Alias name:" keystore_info.txt
              exit 1
          fi
          echo ""

          echo "--- 步骤4.3: 验证 Key 密码 (PKCS12 友好方式) ---"
          # 尝试导出私钥相关信息，如果成功，说明 Key 密码和 Store 密码都对
          # 注意：PKCS12 要求两者一致，所以如果能列出 Entry 详情，基本就没问题
          # 我们这里尝试用 alias 单独列一次来确认
          if keytool -list -v -keystore app/keystore.p12 -alias "${{ secrets.KEY_ALIAS }}" -storepass "${{ secrets.KEYSTORE_PASSWORD }}" -keypass "${{ secrets.KEY_PASSWORD }}" -noprompt > /dev/null 2>&1; then
              echo "✅ Key 密码与 Keystore 匹配 (完美！)"
          else
              echo "❌ Key 密码错误！"
              exit 1
          fi
          echo ""

      - name: 5. 🎉 所有验证通过！
        run: |
          echo "##########################################################################"
          echo "# 🎊 全！部！通！过！🎉                                                 #"
          echo "#                                                                        #"
          echo "# 现在请去运行那个『🚀 RikkaHub 正式版构建』Workflow 吧！              #"
          echo "##########################################################################"
