name: ğŸ” RikkaHub ç­¾åè°ƒè¯•æ„å»º
on:
  workflow_dispatch:

jobs:
  build_debug:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è¿˜åŸ Google Services
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: 3. ğŸ” è§£ç å¯†é’¥ï¼ˆç»å¯¹ç¡®ä¿åœ¨ app ç›®å½•ä¸‹ï¼‰
        run: |
          # å¼ºåˆ¶è¿›å…¥ app ç›®å½•è§£ç ï¼Œé¿å…è·¯å¾„é—®é¢˜
          cd app/
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > release-key.p12
          ls -lh # åˆ—å‡ºå½“å‰ç›®å½•ï¼Œç¡®è®¤æ–‡ä»¶åœ¨è¿™
          pwd # æ‰“å°å½“å‰è·¯å¾„

      - name: 4. ğŸ“ ç”Ÿæˆæ ‡å‡† local.properties
        run: |
          # å›åˆ°é¡¹ç›®æ ¹ç›®å½•
          pwd
          cat > local.properties << EOF
          # CI Auto Generated
          sdk.dir=/usr/local/lib/android/sdk
          storeFile=app/release-key.p12
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          storeType=PKCS12
          EOF
          
          echo "--- ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•ç»“æ„ ---"
          ls -la
          echo ""
          echo "--- ğŸ“‚ App ç›®å½•ç»“æ„ ---"
          ls -la app/
          echo ""
          echo "--- ğŸ“ local.properties å†…å®¹ ---"
          cat local.properties
          echo ""
          echo "--- ğŸ”‘ éªŒè¯å¯†é’¥æ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨ ---"
          if [ -f "app/release-key.p12" ]; then
              echo "âœ… app/release-key.p12 å­˜åœ¨"
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h app/release-key.p12)"
              echo "ğŸ“ ç»å¯¹è·¯å¾„: $(realpath app/release-key.p12)"
          else
              echo "âŒ app/release-key.p12 ä¸å­˜åœ¨ï¼"
          fi

      - name: 5. é…ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 6. æ‰§è¡Œ Gradle å¹¶æ‰“å°ç­¾åä¿¡æ¯ (--info)
        id: gradle_build
        run: |
          chmod +x gradlew
          # åŠ ä¸Š --infoï¼Œè¿™æ · Gradle ä¼šæ‰“å°å‡º SigningConfig çš„åŠ è½½è¿‡ç¨‹
          ./gradlew assembleRelease --no-daemon --info 2>&1 | tee build.log
          
      - name: ğŸ“¤ æ— è®ºæˆåŠŸå¤±è´¥ï¼Œä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-logs
          path: build.log
