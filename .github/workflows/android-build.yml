name: RikkaHub Release Build
on:
  workflow_dispatch:

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è¿˜åŽŸ Google Services
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: è¿˜åŽŸæ—§ç‰ˆå›¾æ ‡ï¼ˆè¦†ç›–ä¸Šæ¸¸æ›´æ–°ï¼‰
        run: |
          # å¤åˆ¶æ—§ç‰ˆå›¾æ ‡è¦†ç›–ä¸Šæ¸¸æ–°ç‰ˆæœ¬
          cp ci-assets/ic_launcher_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp ci-assets/ic_launcher_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp ci-assets/ic_launcher_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

          cp ci-assets/ic_launcher_background_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_background.png
          cp ci-assets/ic_launcher_background_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_background.png

          cp ci-assets/ic_launcher_foreground_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_foreground.png
          cp ci-assets/ic_launcher_foreground_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png

          cp ci-assets/ic_launcher_monochrome_mdpi.png app/src/main/res/mipmap-mdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_hdpi.png app/src/main/res/mipmap-hdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xhdpi.png app/src/main/res/mipmap-xhdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xxhdpi.png app/src/main/res/mipmap-xxhdpi/ic_launcher_monochrome.png
          cp ci-assets/ic_launcher_monochrome_xxxhdpi.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_monochrome.png

          cp ci-assets/rikkahub.svg app/src/main/assets/icons/rikkahub.svg

          echo "âœ… å›¾æ ‡å·²è¿˜åŽŸä¸ºæ—§ç‰ˆæœ¬"

      - name: è§£ç å¯†é’¥åˆ°æ¨¡å—ç›®å½•
        run: |
          # ç›´æŽ¥åœ¨é¡¹ç›®æ ¹ç›®å½•ç”¨ echo é‡å®šå‘åˆ° app/ ä¸‹
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/release-key.p12
          # éªŒè¯æ–‡ä»¶
          ls -lh app/release-key.p12
          stat app/release-key.p12

      - name: ç”Ÿæˆ local.properties
        run: |
          # storeFile åªå†™æ–‡ä»¶åï¼ï¼ï¼ï¼å› ä¸ºæ¨¡å—çº§çš„ file() ç›¸å¯¹äºŽ app/
          cat > local.properties << EOF
          # CI Auto Generated for RikkaHub
          storeFile=release-key.p12
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          storeType=PKCS12
          EOF
          
          # æ‰“å°æœ€ç»ˆå†…å®¹ç¡®è®¤
          echo "--- æœ€ç»ˆ local.properties å†…å®¹ ---"
          cat local.properties
          echo ""
          echo "--- å½“å‰ç›®å½•ç»“æž„ ---"
          ls -la
          echo ""
          echo "--- App æ¨¡å—ç›®å½•ç»“æž„ ---"
          ls -la app/
     
      # - name: æ·»åŠ  R8 è§„åˆ™ï¼Œä¿®å¤ Ktor ç¼ºå¤±ç±»é—®é¢˜
      #   run: |
      #     # ç¡®ä¿ proguard-rules.pro æ–‡ä»¶å­˜åœ¨
      #     if [ ! -f app/proguard-rules.pro ]; then
      #       touch app/proguard-rules.pro
      #     fi
      #     # è§„åˆ™ï¼šå¿½ç•¥ç¼ºå¤±çš„ JVM ç®¡ç†ç±»ï¼Œå¤„ç† Ktor è°ƒè¯•ä»£ç 
      #     cat >> app/proguard-rules.pro << 'EOF'
      #     # Fix for Ktor missing java.lang.management classes on Android
      #     -dontwarn java.lang.management.ManagementFactory
      #     -dontwarn java.lang.management.RuntimeMXBean
      #     -dontwarn io.ktor.util.debug.**
      #     -keep class io.ktor.util.debug.IntellijIdeaDebugDetector { *; }
      #     EOF
        
      - name: ä¿®æ”¹ç‰ˆæœ¬å·
        id: version_update
        run: |
          BUILD_DATE=$(TZ='Asia/Shanghai' date '+%Y%m%d')
          VERSION_NAME=$(grep 'versionName =' app/build.gradle.kts | sed 's/.*versionName = "\([^"]*\)".*/\1/')
          NEW_VERSION_NAME="${VERSION_NAME}-${BUILD_DATE}"
          sed -i "s/versionName = \".*\"/versionName = \"${NEW_VERSION_NAME}\"/" app/build.gradle.kts
          echo "ç‰ˆæœ¬å·å·²æ›´æ–°ï¼š${VERSION_NAME} -> ${NEW_VERSION_NAME}"
          echo "original_version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "new_version=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT      
        
      - name: é…ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: é…ç½® Gradle
        uses: gradle/actions/setup-gradle@v4
         
      - name: èµ‹äºˆæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: æž„å»º APK + AAB
        run: ./gradlew assembleRelease bundleRelease --warning-mode=summary --no-daemon --parallel

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: rikkahub-final-builds
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7

      - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version_info
        run: |
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          ORIGINAL_VERSION=${{ steps.version_update.outputs.original_version }}
          NEW_VERSION_NAME=${{ steps.version_update.outputs.new_version }}

          # èŽ·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©çš„ commit
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r '
              [.[] | select(.commit.author.date >= "'$TODAY_START'")] |
              map("- \(.commit.message | split("\n")[0]) (\(.commit.author.name))") |
              join("\n")
            ')

          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            COMMIT_LIST="* ä»Šå¤©æš‚æ—  commit *"
          fi

          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_VERSION_NAME" >> $GITHUB_OUTPUT

          # ç”Ÿæˆ Release æè¿°
          cat > release_notes.md << EOF
          ðŸ“± RikkaHub ä¸Šæ¸¸é¡¹ç›® https://github.com/rikkahub/rikkahub

          ðŸ”€ ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥ Commit
          $COMMIT_LIST

          âš™ï¸ CI è‡ªå®šä¹‰ä¿®æ”¹
          - ðŸ”„ ä¿®æ”¹äº†ç‰ˆæœ¬å·ï¼š\`${ORIGINAL_VERSION}\` â†’ \`${NEW_VERSION_NAME}\`
          - ðŸŽ¨ ä¿®æ”¹æˆäº†æ—§ç‰ˆçš„å›¾æ ‡æ–‡ä»¶
          - ðŸ”• è¯·æ‰‹åŠ¨å…³é—­æ›´æ–°æ£€æŸ¥ï¼šè®¾ç½® â†’ æ˜¾ç¤º â†’ å…³é—­"å®žæ—¶æ›´æ–°é€šçŸ¥"

          â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
          - ðŸ·ï¸ ç‰ˆæœ¬å·ï¼š**${NEW_VERSION_NAME}**
          - â° æž„å»ºæ—¶é—´ï¼š$BUILD_TIME
          - âœ… æäº¤ SHAï¼š$SHORT_SHA
          - ðŸ”¨ åˆ†æ”¯ï¼š$BRANCH_NAME

          EOF

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ðŸš€ Latest Release (${{ steps.version_info.outputs.short_sha }})
          body_path: release_notes.md
          prerelease: false
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
