name: ðŸš€ RikkaHub é›¶ä»£ç ä¿®æ”¹æž„å»º
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è¿˜åŽŸ Google Services
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: 3. ðŸ” è§£ç å¯†é’¥åˆ° app ç›®å½•
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/release-key.p12
          # éªŒè¯å¯†é’¥æ–‡ä»¶å­˜åœ¨
          ls -lh app/release-key.p12

      - name: 4. ðŸ“ è‡ªåŠ¨ç”Ÿæˆ local.propertiesï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
        run: |
          # åœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ local.propertiesï¼Œè·¯å¾„æ˜¯ç›¸å¯¹äºŽé¡¹ç›®æ ¹ç›®å½•çš„
          cat > local.properties << EOF
          # è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åé…ç½®
          storeFile=app/release-key.p12
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          storeType=PKCS12
          EOF
          # æ‰“å°å†…å®¹éªŒè¯ï¼ˆå¯†ç ä¼šè¢«æ‰“ç ï¼‰
          cat local.properties

      - name: 5. é…ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 6. èµ‹äºˆæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: 7. ðŸ”¨ ç¼–è¯‘ APK + AABï¼ˆçº¯å‡€å‘½ä»¤ï¼‰
        run: ./gradlew assembleRelease bundleRelease --no-daemon --build-cache

      - name: 8. ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: rikkahub-builds
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab

      - name: 9. ðŸš€ å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
