name: ğŸš€ RikkaHub æ­£å¼ç¼–è¯‘å‘å¸ƒ
on:
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡»å‘å¸ƒ
  push:
    tags:
      - 'v*' # æ¨é€åˆ° v1.0.0 è¿™ç§ Tag æ—¶è‡ªåŠ¨å‘å¸ƒ

jobs:
  build_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰ï¼Œæ‰èƒ½åˆ›å»º GitHub Release
    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è¿˜åŸ Firebase é…ç½®æ–‡ä»¶ (google-services.json)
        run: |
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼ˆå¯é€‰ï¼‰
          ls -lha app/google-services.json

      - name: 3. ğŸ” è¿˜åŸ PKCS12 ç­¾åå¯†é’¥
        run: |
          mkdir -p app/
          # ç›´æ¥è§£ç ä¸º p12ï¼Œæ˜¾å¼æŒ‡å®šå¿½ç•¥ base64 å¯èƒ½çš„å¹²æ‰°
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --ignore-garbage -d > app/release-key.p12
          ls -lha app/release-key.p12

      - name: 4. é…ç½® JDK 17 + å¼€å¯ Gradle è‡ªåŠ¨ç¼“å­˜
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle' # setup-java è‡ªå¸¦çš„ç®€å•ä½†é«˜æ•ˆçš„ç¼“å­˜

      - name: 5. é¢å¤–ç¼“å­˜ Gradle Wrapper
        uses: actions/cache@v4
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: 6. èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: 7. ğŸ›¡ï¸ ä¸´æ—¶è¡¥å…¨ Ktor ç›¸å…³ R8 è§„åˆ™ï¼ˆé¿å…æ„å»ºæŠ¥é”™ï¼‰
        run: |
          if [ ! -f app/proguard-rules.pro ]; then
            touch app/proguard-rules.pro
          fi
          # è¿½åŠ è§„åˆ™ï¼ˆå¦‚æœè§„åˆ™å·²å­˜åœ¨ä¼šé‡å¤ï¼Œä½†ä¸å½±å“ï¼Œä¹Ÿå¯ä»¥å…ˆæ£€æŸ¥å†è¿½åŠ ï¼Œè¿™é‡Œå›¾ç®€å•ï¼‰
          cat >> app/proguard-rules.pro << 'EOF'
          # Fix for Ktor missing java.lang.management classes on Android
          -dontwarn java.lang.management.ManagementFactory
          -dontwarn java.lang.management.RuntimeMXBean
          -dontwarn io.ktor.util.debug.**
          -keep class io.ktor.util.debug.IntellijIdeaDebugDetector { *; }
          EOF

      - name: 8. ğŸ”¨ æ ¸å¿ƒç¼–è¯‘ï¼šç”Ÿæˆ Release APK + AABï¼ˆå¸¦ PKCS12 æ˜¾å¼ç­¾åï¼‰
        run: |
          ./gradlew assembleRelease bundleRelease \
            --no-daemon \
            --build-cache \
            --parallel \
            --max-workers=2 \
            # ğŸ”‘ è¿™é‡Œæ˜¯ PKCS12 ä¸“ç”¨çš„å®Œæ•´ç­¾åæ³¨å…¥å‚æ•°
            -Pandroid.injected.signing.store.file=app/release-key.p12 \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            -Pandroid.injected.signing.store.type=PKCS12

      - name: 9. ğŸ“‹ æŸ¥æ‰¾å¹¶åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
        run: |
          echo "--- ğŸ“¦ Release APK æ–‡ä»¶åˆ—è¡¨ ---"
          find app/build/outputs/apk/release -name "*.apk" -type f || echo "âš ï¸ æœªæ‰¾åˆ° APK"
          echo ""
          echo "--- ğŸ“¦ Release AAB æ–‡ä»¶åˆ—è¡¨ ---"
          find app/build/outputs/bundle/release -name "*.aab" -type f || echo "âš ï¸ æœªæ‰¾åˆ° AAB"

      - name: 10. ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Artifactsï¼ˆä¿å­˜ 7 å¤©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: rikkahub-final-release-builds
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7

      - name: 11. ğŸš€ è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releaseï¼ˆä»… Tag æ¨¡å¼è§¦å‘ï¼‰
        uses: softprops/action-gh-release@v2
        # åªæœ‰å½“æ¨é€åˆ° v å¼€å¤´çš„ Tag æ—¶æ‰æ‰§è¡Œå‘å¸ƒï¼Œæ‰‹åŠ¨è§¦å‘åªç”Ÿæˆ Artifacts
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: ğŸ‰ RikkaHub ${{ github.ref_name }} æ­£å¼å‘å¸ƒ
          body: |
            ## ğŸ“± RikkaHub å‘å¸ƒé¡µé¢
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **é€šç”¨ APK**: `app-universal-release.apk`ï¼ˆå¦‚æœé…ç½®äº† splitsï¼‰/ `app-release.apk`ï¼ˆæœªé…ç½®ï¼‰ï¼Œæ‰€æœ‰è®¾å¤‡é€šç”¨ï¼Œæ¨èä¸‹è½½
            - **AAB æ ¼å¼**: `app-release.aab`ï¼ŒGoogle Play å•†åº—ä¸Šæ¶ä¸“ç”¨
            - **æ¶æ„ä¸“ç”¨ APK**: å¦‚ `app-arm64-v8a-release.apk`ï¼Œä½“ç§¯æ›´å°ï¼ˆå¦‚æœé…ç½®äº† splitsï¼‰
            
            ### ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯
            - ç‰ˆæœ¬ Tag: ${{ github.ref_name }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp || 'æŸ¥çœ‹å³ä¾§å‘å¸ƒæ—¶é—´' }}
            - æäº¤ SHA: ${{ github.sha }}
            - æ„å»ºæœºå™¨: Ubuntu Latest
            
            ### âœ¨ ç‰ˆæœ¬äº®ç‚¹ï¼ˆå¾…è¡¥å……ï¼‰
            <!-- è¯·åœ¨è¿™é‡Œæ‰‹åŠ¨æ·»åŠ æœ¬æ¬¡æ›´æ–°çš„å…·ä½“å†…å®¹ï¼Œæˆ–åœ¨ä»“åº“çš„ CHANGELOG.md é‡Œç»´æŠ¤åç²˜è´´è¿‡æ¥ -->
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          fail_on_unmatched_files: true # æ‰¾ä¸åˆ°æ–‡ä»¶å°±æŠ¥é”™ï¼Œé˜²æ­¢ç™½è·‘
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
