name: Test Upstream PR Fetch

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: æµ‹è¯•è·å–ä¸Šæ¸¸ PR
        run: |
          echo "========================================="
          echo "ğŸ§ª æµ‹è¯•è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥åˆå¹¶çš„ PR"
          echo "========================================="
          
          # æ–¹æ³• 1ï¼šä½¿ç”¨ UTC æ—¶é—´ï¼ˆæ¨èï¼‰
          echo ""
          echo "ğŸ“ æ–¹æ³• 1ï¼šä½¿ç”¨ UTC æ—¶é—´"
          TODAY_START_UTC=$(date -u +%Y-%m-%dT00:00:00Z)
          echo "ä»Šæ—¥å¼€å§‹æ—¶é—´ (UTC): $TODAY_START_UTC"
          
          PR_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/pulls?state=closed&per_page=100" | \
            jq -r --arg today "$TODAY_START_UTC" '
              [.[] | select(.merged_at != null and .merged_at >= $today)] |
              sort_by(.merged_at) | reverse |
              .[:20] |
              map("- #\(.number) \(.title) (@\(.user.login))") |
              join("\n")
            ')
          
          echo ""
          echo "ğŸ“‹ PR åˆ—è¡¨:"
          if [ -z "$PR_LIST" ] || [ "$PR_LIST" = "null" ]; then
            echo "* ä»Šå¤©æš‚æ— åˆå¹¶çš„ PR *"
          else
            echo "$PR_LIST"
          fi
          
          # è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºåŸå§‹ API è¿”å›çš„å‰ 3 ä¸ª PR çš„ merged_at
          echo ""
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - æœ€è¿‘ 3 ä¸ªå·²å…³é—­ PR çš„ merged_at:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/pulls?state=closed&per_page=3" | \
            jq -r '.[] | "\(.number): merged_at=\(.merged_at // "null"), title=\(.title)"'
          
          # æ–¹æ³• 2ï¼šä½¿ç”¨ä¸Šæµ·æ—¶é—´ï¼ˆå¯¹æ¯”ï¼‰
          echo ""
          echo "========================================="
          echo "ğŸ“ æ–¹æ³• 2ï¼šä½¿ç”¨ä¸Šæµ·æ—¶é—´ï¼ˆå¯¹æ¯”ï¼‰"
          TODAY_START_SH=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT00:00:00+08:00')
          echo "ä»Šæ—¥å¼€å§‹æ—¶é—´ (ä¸Šæµ·): $TODAY_START_SH"
          
          PR_LIST_SH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/pulls?state=closed&per_page=100" | \
            jq -r --arg today "$TODAY_START_SH" '
              [.[] | select(.merged_at != null and .merged_at >= $today)] |
              sort_by(.merged_at) | reverse |
              .[:20] |
              map("- #\(.number) \(.title) (@\(.user.login))") |
              join("\n")
            ')
          
          echo ""
          echo "ğŸ“‹ PR åˆ—è¡¨:"
          if [ -z "$PR_LIST_SH" ] || [ "$PR_LIST_SH" = "null" ]; then
            echo "* ä»Šå¤©æš‚æ— åˆå¹¶çš„ PR *"
          else
            echo "$PR_LIST_SH"
          fi
          
          echo ""
          echo "========================================="
          echo "âœ… æµ‹è¯•å®Œæˆ"
          echo "========================================="
