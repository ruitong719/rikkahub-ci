name: Test Upstream Commit Fetch

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: æµ‹è¯•è·å–ä¸Šæ¸¸ Commit
        run: |
          echo "========================================="
          echo "ğŸ§ª æµ‹è¯•è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥ Commit"
          echo "========================================="
          
          # è·å–ä»Šæ—¥å¼€å§‹æ—¶é—´ï¼ˆUTCï¼‰
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          echo "ä»Šæ—¥å¼€å§‹æ—¶é—´ (UTC): $TODAY_START"
          echo ""
          
          # è·å–ä»Šå¤©çš„ commit
          echo "ğŸ“‹ è°ƒç”¨ GitHub API è·å– commit..."
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r --arg today "$TODAY_START" '
              [.[] | select(.commit.author.date >= $today)] |
              map("- \(.commit.message | split("\n")[0]) (\(.commit.author.name))") |
              join("\n")
            ')
          
          echo ""
          echo "ğŸ”€ ä»Šæ—¥ Commit åˆ—è¡¨:"
          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            echo "* ä»Šå¤©æš‚æ—  commit *"
          else
            echo "$COMMIT_LIST"
          fi
          
          # è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºåŸå§‹ API è¿”å›çš„å‰ 5 ä¸ª commit
          echo ""
          echo "========================================="
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - åŸå§‹ API è¿”å›çš„å‰ 5 ä¸ª commit:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?per_page=5" | \
            jq -r '.[] | "SHA: \(.sha[0:7]) | Author: \(.commit.author.name) | Date: \(.commit.author.date) | Message: \(.commit.message | split("\n")[0])"'
          
          echo ""
          echo "========================================="
          echo "âœ… æµ‹è¯•å®Œæˆ"
          echo "========================================="
