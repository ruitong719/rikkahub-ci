name: Test Version Info Generation

on:
  workflow_dispatch:

jobs:
  test-version-info:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ¨¡æ‹Ÿä¿®æ”¹ç‰ˆæœ¬å·
        id: version_update
        run: |
          VERSION_NAME="2.0.0"
          BUILD_DATE=$(date +%Y%m%d)
          NEW_VERSION_NAME="${VERSION_NAME}-${BUILD_DATE}"
          echo "original_version=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "new_version=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·å·²æ›´æ–°ï¼š${VERSION_NAME} -> ${NEW_VERSION_NAME}"

      - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰
        id: version_info
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="
          
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BRANCH_NAME=${{ github.ref_name }}
          ORIGINAL_VERSION=${{ steps.version_update.outputs.original_version }}
          NEW_VERSION_NAME=${{ steps.version_update.outputs.new_version }}
          
          echo "BUILD_TIME: $BUILD_TIME"
          echo "SHORT_SHA: $SHORT_SHA"
          echo "BRANCH_NAME: $BRANCH_NAME"
          echo "ORIGINAL_VERSION: $ORIGINAL_VERSION"
          echo "NEW_VERSION_NAME: $NEW_VERSION_NAME"
          
          # è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©çš„ commit
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          echo "TODAY_START: $TODAY_START"
          
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r '
              [.[] | select(.commit.author.date >= "'$TODAY_START'")] |
              map("- \(.commit.message | split("\n")[0]) (\(.commit.author.name))") |
              join("\n")
            ')
          
          echo "=== COMMIT_LIST åŸå§‹å†…å®¹ ==="
          echo "$COMMIT_LIST"
          echo ""
          
          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            COMMIT_LIST="* ä»Šå¤©æš‚æ—  commit *"
          fi
          
          # è¾“å‡ºåˆ° GITHUB_OUTPUTï¼ˆå•è¡Œï¼‰
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_VERSION_NAME" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆ Release æè¿°
          cat > release_notes.md << EOF
          ğŸ“± RikkaHub ä¸Šæ¸¸é¡¹ç›® https://github.com/rikkahub/rikkahub

          ğŸ”€ ä¸Šæ¸¸é¡¹ç›®ä»Šæ—¥ Commit
          $COMMIT_LIST

          âš™ï¸ CI è‡ªå®šä¹‰ä¿®æ”¹
          - ğŸ”„ ä¿®æ”¹äº†ç‰ˆæœ¬å·ï¼š\`${ORIGINAL_VERSION}\` â†’ \`${NEW_VERSION_NAME}\`
          - ğŸ¨ ä¿®æ”¹æˆäº†æ—§ç‰ˆçš„å›¾æ ‡æ–‡ä»¶
          - ğŸ”• è¯·æ‰‹åŠ¨å…³é—­æ›´æ–°æ£€æŸ¥ï¼šè®¾ç½® â†’ æ˜¾ç¤º â†’ å…³é—­"å®æ—¶æ›´æ–°é€šçŸ¥"
          - ğŸŒ æ›´æ–°æ£€æŸ¥åœ°å€å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰åœ°å€

          â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
          - ğŸ·ï¸ ç‰ˆæœ¬å·ï¼š**${NEW_VERSION_NAME}**
          - â° æ„å»ºæ—¶é—´ï¼š$BUILD_TIME
          - âœ… æäº¤ SHAï¼š$SHORT_SHA
          - ğŸ”¨ åˆ†æ”¯ï¼š$BRANCH_NAME
          EOF

          echo "=== release_notes.md å†…å®¹ ==="
          cat release_notes.md

      - name: ç”Ÿæˆæ›´æ–° JSON æ–‡ä»¶
        id: update_json
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆæ›´æ–° JSON ==="
          
          # è·å–æ„å»ºä¿¡æ¯
          NEW_VERSION_NAME=${{ steps.version_update.outputs.new_version }}
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%dT%H:%M:%S+08:00')
          
          # é‡æ–°è·å–ä¸Šæ¸¸é¡¹ç›®ä»Šå¤©çš„ commit ä½œä¸º changelog
          TODAY_START=$(date -u +%Y-%m-%dT00:00:00Z)
          COMMIT_LIST=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rikkahub/rikkahub/commits?since=$TODAY_START&per_page=20" | \
            jq -r '
              [.[] | select(.commit.author.date >= "'$TODAY_START'")] |
              map("- \(.commit.message | split("\n")[0])") |
              join("\n")
            ')
          
          echo "=== COMMIT_LIST åŸå§‹å†…å®¹ ==="
          echo "$COMMIT_LIST"
          echo ""
          
          if [ -z "$COMMIT_LIST" ] || [ "$COMMIT_LIST" = "null" ]; then
            COMMIT_LIST="ä»Šå¤©æš‚æ—  commit"
          fi
          
          # æ¨¡æ‹Ÿ APK æ–‡ä»¶å¤§å°
          APK_SIZE_MB="50.00"
          
          # å›ºå®šä¸‹è½½åœ°å€
          APK_URL="https://gh.llkk.cc/https://github.com/ruitong719/rikkahub-ci/releases/download/latest/app-release.apk"
          
          # ä½¿ç”¨ jq æ­£ç¡®ç”Ÿæˆ JSONï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          jq -n \
            --arg version "${NEW_VERSION_NAME}" \
            --arg publishedAt "${BUILD_TIME}" \
            --arg changelog "${COMMIT_LIST}" \
            --arg name "app-release.apk" \
            --arg url "${APK_URL}" \
            --arg size "${APK_SIZE_MB} MB" \
            '{
              version: $version,
              publishedAt: $publishedAt,
              changelog: $changelog,
              downloads: [
                {
                  name: $name,
                  url: $url,
                  size: $size
                }
              ]
            }' > update.json
          
          echo "=== ç”Ÿæˆçš„ update.json å†…å®¹ ==="
          cat update.json
          echo ""
          echo "=== JSON æ ¼å¼åŒ–éªŒè¯ ==="
          jq . update.json
          
          # éªŒè¯ JSON æ˜¯å¦æœ‰æ•ˆ
          if jq . update.json > /dev/null 2>&1; then
            echo "âœ… JSON æ ¼å¼éªŒè¯é€šè¿‡"
          else
            echo "âŒ JSON æ ¼å¼éªŒè¯å¤±è´¥"
            exit 1
          fi
