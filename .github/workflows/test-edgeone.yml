name: Test EdgeOne Deploy

on:
  workflow_dispatch:

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ¨¡æ‹Ÿç”Ÿæˆ update.json
        id: generate_json
        run: |
          # æ¨¡æ‹Ÿæ„å»ºä¿¡æ¯
          NEW_VERSION_NAME="2.0.0-$(date +%Y%m%d)"
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # æ¨¡æ‹Ÿ COMMIT_LIST
          COMMIT_LIST="æµ‹è¯•æäº¤ 1
          æµ‹è¯•æäº¤ 2
          æµ‹è¯•æäº¤ 3"
          
          # æ¨¡æ‹Ÿ APK æ–‡ä»¶å¤§å°ï¼ˆå‡è®¾ 50MBï¼‰
          APK_SIZE_MB="50.00"
          
          # å›ºå®šä¸‹è½½åœ°å€
          APK_URL="https://gh.llkk.cc/https://github.com/ruitong719/rikkahub-ci/releases/download/latest/app-release.apk"
          
          # ä½¿ç”¨ jq æ­£ç¡®ç”Ÿæˆ JSONï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          jq -n \
            --arg version "${NEW_VERSION_NAME}" \
            --arg publishedAt "${BUILD_TIME}" \
            --arg changelog "${COMMIT_LIST}" \
            --arg name "app-release.apk" \
            --arg url "${APK_URL}" \
            --arg size "${APK_SIZE_MB} MB" \
            '{
              version: $version,
              publishedAt: $publishedAt,
              changelog: $changelog,
              downloads: [
                {
                  name: $name,
                  url: $url,
                  size: $size
                }
              ]
            }' > update.json
          
          echo "=== ç”Ÿæˆçš„ update.json å†…å®¹ ==="
          cat update.json
          echo ""
          echo "=== JSON æ ¼å¼åŒ–éªŒè¯ ==="
          jq . update.json

      - name: éƒ¨ç½²åˆ° EdgeOne Pages
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p edgeone-deploy
          
          # å¤åˆ¶ update.json åˆ°éƒ¨ç½²ç›®å½•
          cp update.json edgeone-deploy/update.json
          
          # æ˜¾ç¤ºéƒ¨ç½²ç›®å½•å†…å®¹
          echo "=== éƒ¨ç½²ç›®å½•å†…å®¹ ==="
          ls -la edgeone-deploy/
          
          # å®‰è£… edgeone CLI
          npm install -g edgeone
          
          # éƒ¨ç½²åˆ° EdgeOne Pages
          edgeone pages deploy edgeone-deploy -n my-rikkahub-update -t ${{ secrets.EDGEONE_API_TOKEN }} -e production
          
          echo "âœ… æ›´æ–°æ–‡ä»¶å·²éƒ¨ç½²åˆ° EdgeOne Pages"
          echo "ğŸ“ è®¿é—®åœ°å€ï¼šhttps://my-rikkahub-update.edgeone.run/update.json"
